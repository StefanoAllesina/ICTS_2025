<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ICTP-ICTS Winter School --- Allesina lecture notes – ch4</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">ICTP-ICTS Winter School — Allesina lecture notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" rel="" target="" aria-current="page">
 <span class="menu-text">Lecture notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./ch4.html">GLV and metatpopulation dynamics</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ICTS QSB 2025</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Generalized Lotka-Volterra model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GLV with random parameters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GLV and experimental data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ch4.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">GLV and metatpopulation dynamics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tutorial/tutorial_GLV_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GLV and experimental data — Hands on tutorial</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#glv-and-metatpopulation-dynamics" id="toc-glv-and-metatpopulation-dynamics" class="nav-link active" data-scroll-target="#glv-and-metatpopulation-dynamics">GLV and metatpopulation dynamics</a>
  <ul class="collapse">
  <li><a href="#metapopulations" id="toc-metapopulations" class="nav-link" data-scroll-target="#metapopulations">Metapopulations</a></li>
  <li><a href="#colonization-competition-tradeoff" id="toc-colonization-competition-tradeoff" class="nav-link" data-scroll-target="#colonization-competition-tradeoff">Colonization-competition tradeoff</a></li>
  <li><a href="#the-model-is-glv" id="toc-the-model-is-glv" class="nav-link" data-scroll-target="#the-model-is-glv">The model is GLV</a></li>
  <li><a href="#computing-equilibria" id="toc-computing-equilibria" class="nav-link" data-scroll-target="#computing-equilibria">Computing equilibria</a></li>
  <li><a href="#random-parameters" id="toc-random-parameters" class="nav-link" data-scroll-target="#random-parameters">Random parameters</a></li>
  <li><a href="#asymptotics" id="toc-asymptotics" class="nav-link" data-scroll-target="#asymptotics">Asymptotics</a></li>
  <li><a href="#references-and-further-readings" id="toc-references-and-further-readings" class="nav-link" data-scroll-target="#references-and-further-readings">References and further readings</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="glv-and-metatpopulation-dynamics" class="level1">
<h1>GLV and metatpopulation dynamics</h1>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="images/Levins.jpg" class="img-fluid figure-img" style="width:40.0%" alt="Richard Levins"></p>
</figure>
</div>
<p>Richard Levins (1930-2016). Born in Brooklyn, New York, he studied agriculture and mathematics at Cornell. Early on, influenced by geneticist and polymath Haldane, he became a Marxist activist. Upon graduation, having been blacklisted as a communist (and with the Korean War raging), he moved to Puerto Rico with his wife, and set up a farm. In his spare time, he conducted experiments on fruit flies, organized anti-colonialist rallies and anti-war protests, and taught at the University of Puerto Rico. In 1964, he was invited to Cuba to help organize the biology department of the University of Havana. He received his doctorate from Columbia University in 1965. In 1967 he moved to the University of Chicago, where he joined Richard Lewontin—whith whom he established a lifelong collaboration. They both moved to Harvard in the late 1970s.</p>
<p>It is impossible to summarize his numerous contributions to ecology, mathematics, political science, and the philosophy of science. He has inspired countless ecologists, and his approach and style are still visible in many of the research programs being carried out today. Of particular interest for this class, his theory of evolution in a changing environment (Levins (1968)), the development of the idea of limiting similarity (MacArthur and Levins (1967)), his work on metapopulation dynamics (Levins (1969)), and the development of Loop Analysis (i.e., a qualitative theory for dynamical systems, Puccia and Levins (2013)).</p>
<section id="metapopulations" class="level2">
<h2 class="anchored" data-anchor-id="metapopulations">Metapopulations</h2>
<p>In 1969, Richard Levins—then a professor at U. Chicago—proposed a simple model for a “metapopulation”, i.e., a “population of populations in which local extinctions are balanced by remigration from other populations” (Levins (1969)).</p>
<p>The model is very simple. Suppose that there are very many patches of suitable habitat, and that we track the proportion of patches occupied by a certain species, <span class="math inline">\(p(t)\)</span>. Two processes affect the proportion of occupied patches: extinction, turning an occupied patch into a vacant patch, and colonization, turning a vacant patch into an occupied patch. For the simplest case, suppose that occupied patches can send “propagules” to empty patches at a fixed rate <span class="math inline">\(\gamma &gt; 0\)</span>, and that the rate at which local populations go extinct is the same for all patches, <span class="math inline">\(\delta &gt; 0\)</span>.</p>
<p>Call <span class="math inline">\(q(t) = 1-p(t)\)</span> the proportion of vacant patches. Then, the dynamics are described by the equations:</p>
<p><span class="math display">\[
\begin{cases}
\dot{p}(t) = -\delta p(t) + \gamma p(t)q(t)\\
\dot{q}(t) = \delta p(t) - \gamma p(t)q(t)\\
\end{cases}
\]</span></p>
<p>in which we assume mass-action (like in GLV). Note that the two equations sum to zero (i.e., we’re in a zero-sum setting), and therefore we can substitute <span class="math inline">\(q(t) = 1-p(t)\)</span> to obtain:</p>
<p><span class="math display">\[
\dot{p} = p(-\delta + \gamma q) = p(\gamma - \delta - \gamma p)
\]</span></p>
<p>which is the usual equation for the logistic growth, with growth rate <span class="math inline">\(\gamma - \delta\)</span> and self-interaction <span class="math inline">\(\gamma\)</span>. As such, as long as <span class="math inline">\(\gamma &gt; \delta\)</span>, the proportion of inhabited patches will converge to <span class="math inline">\(p^\star = 1 - \delta/\gamma &gt; 0\)</span>, which is globally stable.</p>
</section>
<section id="colonization-competition-tradeoff" class="level2">
<h2 class="anchored" data-anchor-id="colonization-competition-tradeoff">Colonization-competition tradeoff</h2>
<p>Levins’ model was extended in a number of ways. One of the most interesting cases is that in which we have <span class="math inline">\(n\)</span> species, each characterized by an extinction and a colonization rate, and there is a trade-off such that better colonizers are worse competitors, and vice versa. In particular:</p>
<ul>
<li><span class="math inline">\(p_i\)</span> is the proportion of patches occupied by population <span class="math inline">\(i\)</span>, with <span class="math inline">\(\sum_j p_j \leq 1\)</span></li>
<li><span class="math inline">\(m_i\)</span> is the extinction rate for population <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(c_i\)</span> is the colonization rate for population <span class="math inline">\(i\)</span></li>
<li>each species can colonize patches occupied by inferior competitors (i.e., these patches “look” empty to them)</li>
<li>competitive abilities are inversely correlated with colonization rates, i.e., if <span class="math inline">\(c_j &lt; c_i\)</span>, then <span class="math inline">\(j\)</span> is a superior competitor</li>
</ul>
<p>The model is a system of <span class="math inline">\(n\)</span> coupled differential equations:</p>
<p><span class="math display">\[
\dot{p}_i = -m_i p_i - \sum_{j=1}^{i-1} c_j p_j p_i + c_i p_i \left(1-\sum_{j=1}^{i} p_j\right)
\]</span></p>
<p>There are three processes at play:</p>
<ul>
<li><span class="math inline">\(-m_i p_i\)</span> the rate at which patches occupied by <span class="math inline">\(i\)</span> become empty</li>
<li><span class="math inline">\(c_j p_j p_i\)</span> propagules from superior competitors <span class="math inline">\(j\)</span> (produced at rate <span class="math inline">\(c_j p_j\)</span>) reach patches occupied by <span class="math inline">\(i\)</span> and turn them over</li>
<li>propagules of <span class="math inline">\(i\)</span>, produced at rate <span class="math inline">\(c_i p_i\)</span>, reach patches that are either empty or occupied by inferior competitors (written as the difference between <span class="math inline">\(1\)</span> and the sum of the proportion of patches occupied by species with equal or better competitive abilities, <span class="math inline">\(1-\sum_{j=1}^{i} p_j\)</span>) and colonize them</li>
</ul>
</section>
<section id="the-model-is-glv" class="level2">
<h2 class="anchored" data-anchor-id="the-model-is-glv">The model is GLV</h2>
<p>With some rearranging, we can write this model as GLV:</p>
<p><span class="math display">\[
\begin{aligned}
\dot{p}_i &amp;= p_i\left(-m_i - \sum_{j=1}^{i-1} c_j p_j + c_i \left(1-\sum_{j=1}^{i} p_j\right)\right)\\
&amp;= p_i\left(-m_i - \sum_{j=1}^{i-1} c_j p_j + c_i - c_i p_i -\sum_{j=1}^{i-1} c_i p_j \right)\\
&amp;= p_i\left(c_i -m_i - c_i p_i -\sum_{j=1}^{i-1} (c_i + c_j) p_j \right)\\
&amp;= p_i\left(r_i - \sum_{j}A_{ij} p_j\right)
\end{aligned}
\]</span> Where we have defined the matrix <span class="math inline">\(A\)</span>:</p>
<p><span class="math display">\[
A = \begin{pmatrix}
c_1 &amp; 0 &amp; 0 &amp;\cdots &amp;0\\
c_1 + c_2 &amp; c_2 &amp; 0 &amp; \cdots &amp; 0\\
c_1 + c_3 &amp; c_2 + c_3 &amp; c_3 &amp; \cdots &amp; 0\\
\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots\\
c_1 + c_n &amp; c_2 + c_n &amp; c_3 + c_n &amp; \cdots &amp; c_n
\end{pmatrix}
\]</span></p>
<p>and <span class="math inline">\(r_i = c_i - m_i\)</span>.</p>
<p>We want to show that for each initial set of species in the system, dynamics will converge to a unique saturated equilibrium.</p>
<p>To prove this, it is sufficient to find a positive diagonal matrix, <span class="math inline">\(D(w)\)</span> such that</p>
<p><span class="math display">\[
M = D(w) A + A^T D(w)
\]</span></p>
<p>is positive definite. Take <span class="math inline">\(w = c^{-1}\)</span> (i.e., the reciprocals of the colonization rates). Then we have that</p>
<p><span class="math display">\[
M = 1_n 1_n^T + Q
\]</span></p>
<p>Where</p>
<p><span class="math display">\[
Q_{ij} = \begin{cases}
1 \quad \text{if}\; j = i\\
\frac{c_i}{c_j} \quad \text{if}\; j &gt; i\\
\frac{c_j}{c_i} \quad \text{if}\; j &lt; i\\
\end{cases}
\]</span></p>
<p>To show that <span class="math inline">\(M\)</span> is positive definite, we write the Cholesky decomposition of <span class="math inline">\(Q\)</span></p>
<p><span class="math display">\[
Q = R^T R
\]</span></p>
<p>With</p>
<p><span class="math display">\[
R_{ij} =
\begin{cases}
\frac{\sqrt{c_i^2 - c_{i-1}^2}}{c_j}  \quad \text{if}\; j \geq i\\
0 \quad \text{if}\; j &lt; i\\
\end{cases}
\]</span></p>
<p>(defining <span class="math inline">\(c_0 = 0\)</span>). Note that all the elements of <span class="math inline">\(R_{ij} \geq 0\)</span>. As such, <span class="math inline">\(Q\)</span> is positive (semi-)definite, and <span class="math inline">\(M\)</span> is the sum of two positive (semi-)definite matrices, and is thus positive (semi-)definite.</p>
<p>An example. Suppose <span class="math inline">\(n = 3\)</span>, then:</p>
<p><span class="math display">\[
A = \begin{pmatrix}
c_1 &amp; 0 &amp; 0\\
c_1 + c_2 &amp; c_2 &amp; 0\\
c_1 + c_3 &amp; c_2 + c_3 &amp; c_3
\end{pmatrix}
\]</span> <span class="math display">\[
M = D(c)^{-1} A + A^T D(c)^{-1}=\begin{pmatrix}
2 &amp; 1 + \frac{c_1}{c_2} &amp; 1 + \frac{c_1}{c_3}\\
1 + \frac{c_1}{c_2} &amp;2 &amp; 1 + \frac{c_2}{c_3}\\
1 + \frac{c_1}{c_3} &amp; 1 + \frac{c_2}{c_3} &amp; 2\\
\end{pmatrix}
\]</span> <span class="math display">\[
Q = \begin{pmatrix}
1 &amp; \frac{c_1}{c_2} &amp; \frac{c_1}{c_3}\\
\frac{c_1}{c_2} &amp; 1 &amp; \frac{c_2}{c_3}\\
\frac{c_1}{c_3} &amp; \frac{c_2}{c_3} &amp; 1\\
\end{pmatrix}
\]</span> <span class="math display">\[
R = \begin{pmatrix}
1 &amp; \frac{c_1}{c_2} &amp; \frac{c_1}{c_3}\\
0 &amp; \frac{c_2^2 - c_1^2}{c_2} &amp; \frac{c_2^2 - c_1^2}{c_3}\\
0 &amp; 0 &amp; \frac{c_3^2 - c_2^2}{c_3}
\end{pmatrix} \quad Q = R^T R
\]</span></p>
</section>
<section id="computing-equilibria" class="level2">
<h2 class="anchored" data-anchor-id="computing-equilibria">Computing equilibria</h2>
<p>For simplicity, we are going to consider the case in which <span class="math inline">\(m_i = m\)</span> for all <span class="math inline">\(i\)</span>. Because the matrix is lower-triangular, computing the equilibrium is especially simple, because each the value of each species depends only on those of the preceding species. The equilibrium of the first species is given by:</p>
<p><span class="math display">\[
c_1 p_1 = c_1 -m
\]</span></p>
<p>and thus</p>
<p><span class="math display">\[
p_1^\star = \frac{c_1 - m}{c_1} = 1 - \frac{m}{c_1}
\]</span></p>
<p>The first species follows the Levins’ model, and persists as long as <span class="math inline">\(c_1 &gt; m\)</span>. We compute the equilibrium for the second species, assuming that the first species is present:</p>
<p><span class="math display">\[
\begin{aligned}
(c_1 + c_2) p_1^\star + c_2 p_2^\star = c_2 - m\\
(c_1 + c_2)\left(1 - \frac{m}{c_1}\right) + c_2 p_2^\star &amp;=  c_2 - m\\
c_1 + c_2 - m - m \frac{c_2}{c_1} +  c_2 p_2^\star &amp;=  c_2 - m\\
p_2^\star = \frac{m}{c_1} - \frac{c_1}{c_2}
\end{aligned}
\]</span></p>
<p>Thus, species 2 can establish if:</p>
<p><span class="math display">\[
c_2 &gt; \frac{c_1^2}{m}
\]</span></p>
<p>Computing the equilibrium of the third species we find that it is positive if:</p>
<p><span class="math display">\[
c_3 &gt; \frac{c_2^2}{\frac{c_1^2}{m}}
\]</span></p>
<p>You can see that there is a simple pattern. Call <span class="math inline">\(l_0 = m\)</span>, then the condition for the first species to persist is that <span class="math inline">\(c_1 &gt; l_0\)</span>; second species to persist whenever <span class="math inline">\(c_2 &gt; c_1^2 / l_0 = l_1\)</span>; the third species persists whenever <span class="math inline">\(c_3 &gt; c_2^2 / l_1\)</span>, and so forth:</p>
<p><span class="math display">\[
l_i = \frac{c_i^2}{l_{i-1}}
\]</span></p>
<p>This value represents the “shadow” each species that establishes casts on the colonization axis. A worse competitor <span class="math inline">\(i + 1\)</span> can establish if and only if:</p>
<p><span class="math display">\[
c_{i+1} &gt; l_i
\]</span></p>
<p>Thus, if the species has a sufficiently large colonization rate, it will establish; if not, it will go extinct. In this way, we can compute the set of coexisting species in <em>linear time</em> (i.e., without the need to invert the matrix).</p>
</section>
<section id="random-parameters" class="level2">
<h2 class="anchored" data-anchor-id="random-parameters">Random parameters</h2>
<p>Sample the colonization rate values from a distribution (with positive support); for example <span class="math inline">\(\gamma_i \sim \mathcal U[0,1]\)</span>. Then sort them and assign the smallest value to species 1, the second smallest value to species 2, etc. These are called the <em>order statistics</em> of the distribution.</p>
<p>How many species will coexist?</p>
</section>
<section id="asymptotics" class="level2">
<h2 class="anchored" data-anchor-id="asymptotics">Asymptotics</h2>
</section>
<section id="references-and-further-readings" class="level2">
<h2 class="anchored" data-anchor-id="references-and-further-readings">References and further readings</h2>
<p>TODO</p>
<p>May R.M. 1972. Will a large complex system be stable? Nature 238:413-414</p>
<p>McCann, K.S. 2000. The diversity - stability debate. Nature 405:228-233</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>